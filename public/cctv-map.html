<!DOCTYPE html>
<html>
  <head>
    <title>香港交通CCTV分布地图</title>
    <script src="./OpenLayers.js"></script>
    <script src="./config.js"></script>
    <script src="./map-styles.js"></script>
    <style>
      #mapdiv {
        width: 100%;
        height: 100vh;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      /* 地图样式选择器 */
      .map-style-selector {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .map-style-selector select {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        background: white;
      }
      .olPopup {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
      }
      .olPopupContent {
        background: transparent !important;
        overflow: visible !important;
      }
      .popup {
        background: rgba(255, 255, 255, 0.98);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 14px;
        padding: 12px 14px;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.14);
        position: relative;
        max-width: 460px;
        min-width: 300px;
        max-height: 70vh;
        overflow: auto;
      }
      .popup h4 {
        margin: 0 0 10px 0;
        color: #111827;
        font-size: 15px;
        word-wrap: break-word;
      }
      .popup p {
        margin: 5px 0;
        color: #374151;
        font-size: 13px;
      }
      .popup .close {
        position: absolute;
        top: 6px;
        right: 8px;
        color: #6b7280;
        text-decoration: none;
        font-size: 16px;
        line-height: 16px;
        padding: 2px;
        border-radius: 6px;
      }
      .popup .close:hover {
        background: rgba(0, 0, 0, 0.06);
        color: #111827;
      }
      .popup img {
        max-width: 100%;
        height: auto;
        max-height: 60vh;
        margin-top: 8px;
        border-radius: 8px;
        display: block;
      }
      .popup .cctv-image {
        text-align: center;
        margin-top: 8px;
        width: 100%;
      }
      .popup .loading {
        text-align: center;
        color: #999;
        font-style: italic;
      }
      .popup .error {
        text-align: center;
        color: #ff6b6b;
        font-size: 11px;
      }

      @media (max-width: 480px) {
        .popup {
          max-width: 92vw;
          padding: 10px 12px;
        }
      }
    </style>
  </head>
  <body>
    <div id="mapdiv"></div>

    <!-- 地图样式选择器 -->
    <div class="map-style-selector">
      <select id="mapStyleSelector" onchange="changeMapStyle(this.value)">
        <option value="cartodb-light">CartoDB 浅色</option>
        <option value="osm">OpenStreetMap 标准</option>
        <option value="cartodb-dark">CartoDB 深色</option>
        <option value="cartodb-positron">CartoDB 简洁</option>
        <option value="opentopomap">地形图</option>
        <option value="wikimedia" selected>维基地图</option>
        <option value="esri-satellite">ESRI 卫星图</option>
      </select>
    </div>
    <script>
      let map;
      let markersLayer;
      let currentPopup = null;

      // 初始化地图
      function initMap() {
        map = new OpenLayers.Map("mapdiv");

        // 使用通用样式初始化，默认为维基地图
        initMapWithStyle(map, "wikimedia");

        // 创建标记层
        markersLayer = new OpenLayers.Layer.Markers("CCTV Cameras");
        map.addLayer(markersLayer);

        // 设置初始视图为香港
        var hongKongCenter = new OpenLayers.LonLat(114.1694, 22.3193).transform(
          new OpenLayers.Projection("EPSG:4326"),
          map.getProjectionObject()
        );

        map.setCenter(hongKongCenter, 12);

        // 加载CCTV数据
        loadCCTVData();
      }

      // 加载CCTV数据
      async function loadCCTVData() {
        try {
          const response = await fetch(
            `${window.APP_CONFIG.API_BASE_URL}/cctv`
          );
          const data = await response.json();

          // 过滤出有效的CCTV数据
          const cctvCameras = data.filter(
            (item) =>
              item.description && item.latitude && item.longitude && item.url
          );

          console.log(`Loaded ${cctvCameras.length} CCTV cameras`);

          // 添加标记
          cctvCameras.forEach((camera) => {
            addCCTVMarker(camera);
          });
        } catch (error) {
          console.error("Failed to load CCTV data:", error);
        }
      }

      // 添加CCTV标记
      function addCCTVMarker(camera) {
        if (!camera.latitude || !camera.longitude) return;

        const lonLat = new OpenLayers.LonLat(
          parseFloat(camera.longitude),
          parseFloat(camera.latitude)
        ).transform(
          new OpenLayers.Projection("EPSG:4326"),
          map.getProjectionObject()
        );

        // 创建自定义CCTV标记图标
        var size = new OpenLayers.Size(18, 18);
        var offset = new OpenLayers.Pixel(-(size.w / 2), -size.h);
        var icon = new OpenLayers.Icon(
          "data:image/svg+xml;base64," +
            btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                    <circle cx="9" cy="9" r="7" fill="#FF6B35" stroke="white" stroke-width="2"/>
                    <circle cx="9" cy="9" r="4" fill="white"/>
                    <circle cx="9" cy="9" r="2" fill="#FF6B35"/>
                </svg>
            `),
          size,
          offset
        );

        const marker = new OpenLayers.Marker(lonLat, icon);

        // 添加点击事件
        marker.events.register("mousedown", marker, function (evt) {
          showCCTVPopup(camera, lonLat);
          OpenLayers.Event.stop(evt);
        });

        markersLayer.addMarker(marker);
      }

      // 显示CCTV信息弹窗
      function showCCTVPopup(camera, lonLat) {
        if (currentPopup) {
          try {
            map.removePopup(currentPopup);
            currentPopup.destroy();
          } catch (_) {}
          currentPopup = null;
        }
        if (map.popups.length > 0) {
          try {
            map.removePopup(map.popups[0]);
          } catch (_) {}
        }

        const html = `
          <div class="popup">
            <a href="#" id="cctv-close" class="close" aria-label="close">×</a>
            <h4>${camera.description}</h4>
            <p><strong>区域:</strong> ${camera.region}</p>
            <p><strong>地区:</strong> ${camera.district}</p>
            <p><strong>代码:</strong> ${camera.key}</p>
            <p><strong>坐标:</strong> ${parseFloat(camera.latitude).toFixed(
              4
            )}, ${parseFloat(camera.longitude).toFixed(4)}</p>
            <div class="cctv-image" id="cctv-image-${camera.key}">
              <div class="loading">正在加载图片...</div>
            </div>
          </div>`;

        const popup = new OpenLayers.Popup(
          "cctvPopup",
          lonLat,
          new OpenLayers.Size(360, 1),
          html,
          false
        );
        popup.autoSize = true;
        popup.panMapIfOutOfView = true;
        map.addPopup(popup);
        currentPopup = popup;

        // 异步加载CCTV图片 - 等待DOM元素创建完成
        setTimeout(() => {
          loadCCTVImage(camera);
          const btn = document.getElementById("cctv-close");
          if (btn)
            btn.onclick = (e) => {
              e.preventDefault();
              if (currentPopup) {
                try {
                  map.removePopup(currentPopup);
                  currentPopup.destroy();
                } catch (_) {}
                currentPopup = null;
              }
            };
        }, 100);
      }

      // 加载CCTV图片
      function loadCCTVImage(camera) {
        const imageContainer = document.getElementById(
          `cctv-image-${camera.key}`
        );
        if (!imageContainer) {
          console.error(`Image container not found for camera ${camera.key}`);
          return;
        }

        console.log(`Loading image for camera ${camera.key}: ${camera.url}`);

        const img = new Image();

        img.onload = function () {
          imageContainer.innerHTML = `<img src="${camera.url}" alt="CCTV ${camera.key}" style="max-width:100%;height:auto;" />`;
          console.log(`Image loaded successfully for camera ${camera.key}`);
          // 载入后强制更新弹窗尺寸并自动平移至可见范围
          setTimeout(() => {
            try {
              if (currentPopup) {
                if (typeof currentPopup.updateSize === "function")
                  currentPopup.updateSize();
                if (typeof currentPopup.panIntoView === "function")
                  currentPopup.panIntoView();
                else if (map && currentPopup.lonlat)
                  map.panTo(currentPopup.lonlat);
              }
            } catch (e) {}
          }, 0);
        };

        img.onerror = function () {
          console.error(
            `Image failed to load for camera ${camera.key}: ${camera.url}`
          );
          imageContainer.innerHTML = `
            <div class="error">
              图片加载失败<br>
              <a href="${camera.url}" target="_blank" style="color: #007bff; text-decoration: underline;">
                点击查看原图
              </a>
            </div>
          `;
        };

        // 设置图片源，开始加载
        img.src = camera.url;

        // 设置超时时间（10秒）
        setTimeout(() => {
          if (imageContainer.querySelector(".loading")) {
            console.warn(`Image loading timeout for camera ${camera.key}`);
            imageContainer.innerHTML = `
              <div class="error">
                图片加载超时<br>
                <a href="${camera.url}" target="_blank" style="color: #007bff; text-decoration: underline;">
                  点击查看原图
                </a>
              </div>
            `;
          }
        }, 10000);
      }

      // URL参数处理（用于单独查看某个CCTV）
      function handleUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const lat = urlParams.get("lat");
        const lng = urlParams.get("lng");
        const name = urlParams.get("name");
        const key = urlParams.get("key");
        const region = urlParams.get("region");
        const district = urlParams.get("district");
        const url = urlParams.get("url");

        if (lat && lng) {
          const targetLonLat = new OpenLayers.LonLat(
            parseFloat(lng),
            parseFloat(lat)
          ).transform(
            new OpenLayers.Projection("EPSG:4326"),
            map.getProjectionObject()
          );

          map.setCenter(targetLonLat, 16);

          if (name && key) {
            // 为特定CCTV创建高亮标记
            var size = new OpenLayers.Size(22, 22);
            var offset = new OpenLayers.Pixel(-(size.w / 2), -size.h);
            var highlightIcon = new OpenLayers.Icon(
              "data:image/svg+xml;base64," +
                btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 22 22">
                            <circle cx="11" cy="11" r="9" fill="#EF4444" stroke="white" stroke-width="2"/>
                            <circle cx="11" cy="11" r="5" fill="white"/>
                            <circle cx="11" cy="11" r="2" fill="#EF4444"/>
                        </svg>
                    `),
              size,
              offset
            );

            const highlightMarker = new OpenLayers.Marker(
              targetLonLat,
              highlightIcon
            );
            markersLayer.addMarker(highlightMarker);

            // 创建包含完整信息的CCTV对象
            const camera = {
              key: key || "",
              region: region || "",
              district: district || "",
              description: decodeURIComponent(name || ""),
              latitude: lat,
              longitude: lng,
              url: url || "",
            };

            // 显示完整的CCTV信息弹窗，包含图片
            setTimeout(() => {
              showCCTVPopup(camera, targetLonLat);
            }, 500);
          }
        }
      }

      // 页面加载完成后初始化
      window.onload = function () {
        initMap();
        setTimeout(handleUrlParams, 1000); // 等待地图加载完成后处理URL参数
      };
    </script>
  </body>
</html>
