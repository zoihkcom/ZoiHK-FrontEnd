<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>FEHD 设施分布地图</title>
    <script src="./OpenLayers.js"></script>
    <script src="./map-styles.js"></script>
    <style>
      #mapdiv {
        width: 100%;
        height: 100vh;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      /* 地图样式选择器 */
      .map-style-selector {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .map-style-selector select {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        background: white;
      }
      /* 统一去除OpenLayers默认popup底图，使卡片不透明 */
      .olPopup {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
      }
      .olPopupContent {
        background: transparent !important;
        overflow: visible !important;
      }
      .popup {
        background: rgba(255, 255, 255, 0.97);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        padding: 10px 12px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        position: relative;
        max-width: 280px;
      }
      .popup h4 {
        margin: 0 0 8px 0;
        color: #111827;
        font-size: 14px;
      }
      .popup p {
        margin: 4px 0;
        color: #374151;
        font-size: 12px;
      }
      .popup .close {
        position: absolute;
        top: 6px;
        right: 8px;
        color: #6b7280;
        text-decoration: none;
        font-size: 16px;
        line-height: 16px;
        padding: 2px;
        border-radius: 6px;
      }
      .popup .close:hover {
        background: rgba(0, 0, 0, 0.06);
        color: #111827;
      }
    </style>
  </head>
  <body>
    <div id="mapdiv"></div>

    <!-- 地图样式选择器 -->
    <div class="map-style-selector">
      <select id="mapStyleSelector" onchange="changeMapStyle(this.value)">
        <option value="cartodb-light">CartoDB 浅色</option>
        <option value="osm">OpenStreetMap 标准</option>
        <option value="cartodb-dark">CartoDB 深色</option>
        <option value="cartodb-positron">CartoDB 简洁</option>
        <option value="opentopomap">地形图</option>
        <option value="wikimedia" selected>维基地图</option>
        <option value="esri-satellite">ESRI 卫星图</option>
      </select>
    </div>
    <script>
      let map;
      let markersLayer;
      let mapReady = false;
      let pendingPlot = null;
      let currentPopup = null;

      function initMap() {
        map = new OpenLayers.Map("mapdiv");

        // 使用通用样式初始化，默认为维基地图
        initMapWithStyle(map, "wikimedia");

        markersLayer = new OpenLayers.Layer.Markers("Facilities");
        map.addLayer(markersLayer);

        const hkCenter = new OpenLayers.LonLat(114.1694, 22.3193).transform(
          new OpenLayers.Projection("EPSG:4326"),
          map.getProjectionObject()
        );
        map.setCenter(hkCenter, 12);
        mapReady = true;
        // 如果有父页面早于初始化发送的数据，这里补绘
        if (pendingPlot && Array.isArray(pendingPlot) && pendingPlot.length) {
          plot(pendingPlot);
          pendingPlot = null;
        }
      }

      function clearMarkers() {
        if (!markersLayer) return;
        markersLayer.clearMarkers();
        // 移除弹窗
        while (map && map.popups && map.popups.length) {
          map.removePopup(map.popups[0]);
        }
      }

      function addFacilityMarker(item) {
        if (!item || !item.lat || !item.lon) return;
        const lonLat = new OpenLayers.LonLat(
          parseFloat(item.lon),
          parseFloat(item.lat)
        ).transform(
          new OpenLayers.Projection("EPSG:4326"),
          map.getProjectionObject()
        );

        const size = new OpenLayers.Size(16, 16);
        const offset = new OpenLayers.Pixel(-(size.w / 2), -size.h);
        const icon = new OpenLayers.Icon(
          "data:image/svg+xml;base64," +
            btoa(`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
              <circle cx="8" cy="8" r="6" fill="#3B82F6" stroke="white" stroke-width="2"/>
              <circle cx="8" cy="8" r="3" fill="white"/>
            </svg>
          `),
          size,
          offset
        );

        const marker = new OpenLayers.Marker(lonLat, icon);
        marker.events.register("mousedown", marker, function (evt) {
          showPopup(item, lonLat);
          OpenLayers.Event.stop(evt);
        });
        markersLayer.addMarker(marker);
        return lonLat;
      }

      function showPopup(item, lonLat) {
        // 移除旧弹窗
        if (currentPopup) {
          try {
            map.removePopup(currentPopup);
            currentPopup.destroy();
          } catch (_) {}
          currentPopup = null;
        }
        if (map.popups.length > 0) {
          try {
            map.removePopup(map.popups[0]);
          } catch (_) {}
        }

        const html = `
          <div class="popup">
            <a href="#" id="fehd-close" class="close" aria-label="close">×</a>
            <h4>${item.name || ""}</h4>
            ${item.type ? `<p><strong>类型:</strong> ${item.type}</p>` : ""}
            ${
              item.district
                ? `<p><strong>地区:</strong> ${item.district}</p>`
                : ""
            }
            ${
              item.address
                ? `<p><strong>地址:</strong> ${item.address}</p>`
                : ""
            }
            ${
              item.openHr
                ? `<p><strong>开放时间:</strong> ${item.openHr}</p>`
                : ""
            }
            ${
              item.updatedAt
                ? `<p><strong>更新:</strong> ${item.updatedAt}</p>`
                : ""
            }
            ${
              item.remarks
                ? `<p><strong>备注:</strong> ${item.remarks}</p>`
                : ""
            }
          </div>
        `;

        const popup = new OpenLayers.Popup(
          "fehdPopup",
          lonLat,
          new OpenLayers.Size(260, 1),
          html,
          false // 不使用默认closeBox，避免缺失图片
        );
        popup.autoSize = true;
        map.addPopup(popup);
        currentPopup = popup;

        // 绑定自定义关闭
        setTimeout(() => {
          const btn = document.getElementById("fehd-close");
          if (btn) {
            btn.onclick = function (e) {
              e.preventDefault();
              if (currentPopup) {
                try {
                  map.removePopup(currentPopup);
                  currentPopup.destroy();
                } catch (_) {}
                currentPopup = null;
              }
            };
          }
        }, 0);
      }

      // 批量绘制并自适应视野
      function plot(items) {
        if (!mapReady) {
          // 地图尚未初始化，暂存数据，待初始化完成后绘制
          pendingPlot = items;
          return;
        }
        clearMarkers();
        if (!items || !items.length) return;
        const bounds = new OpenLayers.Bounds();
        items.forEach((it) => {
          const ll = addFacilityMarker(it);
          if (ll) bounds.extend(ll);
        });
        if (bounds.left !== undefined) {
          map.zoomToExtent(bounds);
          // 放大限制，避免过分缩放
          if (map.getZoom() > 16) map.zoomTo(16);
        }
      }

      function handleUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const lat = parseFloat(params.get("lat"));
        const lng = parseFloat(params.get("lng"));
        const name = params.get("name");
        if (!isNaN(lat) && !isNaN(lng)) {
          const ll = new OpenLayers.LonLat(lng, lat).transform(
            new OpenLayers.Projection("EPSG:4326"),
            map.getProjectionObject()
          );
          map.setCenter(ll, 16);

          // 高亮标记
          const size = new OpenLayers.Size(20, 20);
          const offset = new OpenLayers.Pixel(-(size.w / 2), -size.h);
          const highlightIcon = new OpenLayers.Icon(
            "data:image/svg+xml;base64," +
              btoa(`
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">
                <circle cx="10" cy="10" r="8" fill="#EF4444" stroke="white" stroke-width="2"/>
                <circle cx="10" cy="10" r="4" fill="white"/>
              </svg>
            `),
            size,
            offset
          );
          const marker = new OpenLayers.Marker(ll, highlightIcon);
          markersLayer.addMarker(marker);
          if (name) {
            setTimeout(() => {
              if (currentPopup) {
                try {
                  map.removePopup(currentPopup);
                  currentPopup.destroy();
                } catch (_) {}
                currentPopup = null;
              }
              const popup = new OpenLayers.Popup(
                "highlightPopup",
                ll,
                new OpenLayers.Size(220, 1),
                `<div class="popup"><h4>${decodeURIComponent(name)}</h4></div>`,
                false
              );
              popup.autoSize = true;
              map.addPopup(popup);
              currentPopup = popup;
            }, 400);
          }
        }
      }

      // 监听父窗口消息
      window.addEventListener("message", (event) => {
        const data = event.data || {};
        if (data.action === "plot") {
          const items = Array.isArray(data.items) ? data.items : [];
          if (!mapReady) {
            pendingPlot = items;
          } else {
            plot(items);
          }
        }
      });

      window.onload = function () {
        initMap();
        setTimeout(handleUrlParams, 500);
      };
    </script>
  </body>
</html>
